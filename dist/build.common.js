"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class t{static isNodeEnvironment(){return"[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)}static getGlobal(){return this.isNodeEnvironment()?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:this.fallbackGlobalObject}}t.fallbackGlobalObject={};class e{static calculateRotatedRectCoordinates({x:t,y:e,width:i,height:a,degree:s=0}){let n,r,o,h;if(s){const c=t+i/2,d=e+a/2;n=this.calculateRotationCoordinate({x:t,y:e,cx:c,cy:d,degree:s}),r=this.calculateRotationCoordinate({x:t+i,y:e,cx:c,cy:d,degree:s}),o=this.calculateRotationCoordinate({x:t+i,y:e+a,cx:c,cy:d,degree:s}),h=this.calculateRotationCoordinate({x:t,y:e+a,cx:c,cy:d,degree:s})}else n={x:t,y:e},r={x:t+i,y:e},o={x:t+i,y:e+a},h={x:t,y:e+a};return{topleft:n,topright:r,bottomright:o,bottomleft:h}}static calculateRotationCoordinate({x:t,y:e,cx:i=0,cy:a=0,degree:s=0}){const n=s*(Math.PI/180),r=Math.sin(n),o=Math.cos(n);return{x:o*(t-i)-r*(e-a)+i,y:r*(t-i)+o*(e-a)+a}}static calculateCenterCoordinate(...t){const e=t.reduce((t,{x:e,y:i})=>(t.x+=e,t.y+=i,t),{x:0,y:0});return e.x/=t.length,e.y/=t.length,e}static calculateAngleBetweenCoordinates(t,e){return 180*Math.atan2(e.y-t.y,e.x-t.x)/Math.PI}static calculateFitDimensions({objectFit:t,intrinsicWidth:e,intrinsicHeight:i,intrinsicTop:a=0,intrinsicLeft:s=0,actualWidth:n,actualHeight:r}){let o=a,h=s,c=e,d=i;if("contain"===t||"cover"===t||"scale-down"===t){const l=e/n,u=i/r,g="contain"===t||"scale-down"===t?Math.min(l,u):Math.max(l,u);o=a+(i-r*g)/2,h=s+(e-n*g)/2,c=n*g,d=r*g}return{top:o,left:h,width:c,height:d}}static getMediaDimensions(t){return t instanceof HTMLImageElement?{width:t.naturalWidth,height:t.naturalHeight}:t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:{width:t.width,height:t.height}}static isMediaLoaded(t){return t instanceof HTMLImageElement&&t.complete||t instanceof HTMLVideoElement&&4===t.readyState}static drawPoint(t,{x:e,y:i,r:a=3,color:s="aqua"}){const n=t.getContext("2d");n.beginPath(),n.arc(e,i,a,0,2*Math.PI),n.fillStyle=s,n.fill()}static drawCenterPoint(t,{points:e,r:i=3,color:a="aqua"}){const{x:s,y:n}=this.calculateCenterCoordinate(...e);this.drawPoint(t,{x:s,y:n,r:i,color:a})}static drawRect(t,{x:e,y:i,width:a,height:s,degree:n=0,lineWidth:r=2,color:o="aqua"}){const{topleft:h,topright:c,bottomright:d,bottomleft:l}=this.calculateRotatedRectCoordinates({x:e,y:i,width:a,height:s,degree:n}),u=t.getContext("2d");u.beginPath(),u.moveTo(h.x,h.y),u.lineTo(c.x,c.y),u.lineTo(d.x,d.y),u.lineTo(l.x,l.y),u.closePath(),u.lineWidth=r,u.strokeStyle=o,u.stroke()}static flipHorizontal(t){const e=t.getContext("2d"),i=e.getImageData(0,0,t.width,t.height);for(let t=0;t<i.height;t++)for(let e=0;e<i.width/2;e++){const a=4*t*i.width+4*e,s=4*(t+1)*i.width-4*(e+1);for(let t=0;t<4;t++){let e=i.data[a+t];i.data[a+t]=i.data[s+t],i.data[s+t]=e}}e.putImageData(i,0,0,0,0,i.width,i.height)}}class i extends HTMLElement{constructor(){super(),this.global=t.getGlobal(),this.handlers={}}connectedCallback(){}static get is(){return""}static define(){const e=t.getGlobal();return e.customElements.get(this.is)?this:(e.customElements.define(this.is,this),this)}static createElement(){return this.define(),new(t.getGlobal().customElements.get(this.is))}on(t,e){return this.handlers[t]=e,this}get width(){return this.getAttribute("width")?parseInt(this.getAttribute("width")||"0",10):0}set width(t){this.setAttribute("width",t.toString())}get height(){return this.getAttribute("height")?parseInt(this.getAttribute("height")||"0",10):0}set height(t){this.setAttribute("height",t.toString())}}class a extends i{constructor(){super(),this.extends=document.createElement("canvas"),this.style.boxSizing="border-box",this.style.display="block",this.style.overflow="hidden","static"===getComputedStyle(this).position&&(this.style.position="relative");const t=parseFloat(getComputedStyle(this).width)>0,e=parseFloat(getComputedStyle(this).height)>0;this.appendChild(this.extends),t||(this.style.width=getComputedStyle(this.extends).width),e||(this.style.height=getComputedStyle(this.extends).height),this.extends.style.boxSizing="border-box",this.extends.style.width="100%",this.extends.style.height="100%",this.observer=new MutationObserver(t=>{for(let e of t)/^width|height$/.test(e.attributeName)&&this.extends.setAttribute(e.attributeName,this.getAttribute(e.attributeName))}),this.observer.observe(this,{attributes:!0,attributeFilter:["width","height"],attributeOldValue:!0})}static get is(){return"xtejs-canvas"}drawImage(t,e=0,i=0,a,s,n,r,o,h){return void 0!==a&&void 0!==s&&void 0!==n&&void 0!==r&&void 0!==o&&void 0!==h?this.extends.getContext("2d").drawImage(t,e,i,a,s,n,r,o,h):void 0!==a&&void 0!==s?this.extends.getContext("2d").drawImage(t,e,i,a,s):this.extends.getContext("2d").drawImage(t,e,i),this}drawImageScaled(t){const i=e.getMediaDimensions(t),a=this.extends.width/i.width,s=this.extends.height/i.height,n=Math.min(a,s),r=(this.extends.width-i.width*n)/2,o=(this.extends.height-i.height*n)/2;return this.drawImage(t,0,0,i.width,i.height,r,o,i.width*n,i.height*n),this}drawPoint({x:t,y:i,r:a=3,color:s="aqua"}){return e.drawPoint(this.extends,{x:t,y:i,r:a,color:s}),this}drawCenterPoint({points:t,r:i=3,color:a="aqua"}){return e.drawCenterPoint(this.extends,{points:t,r:i,color:a}),this}drawRect({x:t,y:i,width:a,height:s,degree:n=0,lineWidth:r=2,color:o="aqua"}){return e.drawRect(this.extends,{x:t,y:i,width:a,height:s,degree:n,lineWidth:r,color:o}),this}flipHorizontal(){return e.flipHorizontal(this.extends),this}clear(){return this.extends.getContext("2d").clearRect(0,0,this.extends.width,this.extends.height),this}toDataURL(t=!1){return t&&this.flipHorizontal(),this.extends.toDataURL("image/png",1)}}a.define();class s{static async open(t,e){await new Promise(async(i,a)=>{try{this.close(t),t.srcObject=await navigator.mediaDevices.getUserMedia(e),t.addEventListener("loadedmetadata",()=>{i()},{once:!0}),t.addEventListener("error",()=>{a(t.error)},{once:!0})}catch(t){a(t)}})}static close(t){if(t.srcObject){for(let e of t.srcObject.getTracks())e.stop();t.srcObject=null}}}class n extends i{constructor(){super(),this.extends=document.createElement("video"),this.canvas=a.createElement(),this.cameraFace=void 0,this.appendChild(this.extends),this.style.boxSizing="border-box",this.style.display="block","static"===getComputedStyle(this).position&&(this.style.position="relative"),this.style.width||(this.style.width=getComputedStyle(this.extends).width),this.style.height||(this.style.height=getComputedStyle(this.extends).height),this.extends.setAttribute("playsinline","true"),this.extends.setAttribute("muted","true"),this.extends.style.boxSizing="border-box",this.extends.style.width="100%",this.extends.style.height="100%",this.extends.style.objectFit="cover",this.observer=new MutationObserver(t=>{for(let e of t)/^width|height$/.test(e.attributeName)&&this.extends.setAttribute(e.attributeName,this.getAttribute(e.attributeName))}),this.observer.observe(this,{attributes:!0,attributeFilter:["width","height"],attributeOldValue:!0})}static get is(){return"xtejs-camera"}get tracks(){return this.extends.srcObject?this.extends.srcObject.getTracks():[]}static get resolutions(){return{FHD:{width:1920,height:1080},HD:{width:1280,height:720},VGA:{width:640,height:480},HVGA:{width:480,height:320},QVGA:{width:320,height:240}}}async getPermission(){if(!navigator.permissions||!navigator.permissions.query)return;const t=await navigator.permissions.query({name:"camera"});return console.log(`Current permission: ${t.state}`),t.state}async revokePermission(){}get opened(){return this.tracks.length>0}constraints(){if(this.tracks.length)return this.tracks[0].getConstraints()}async open(t="back",e="HD"){try{if(this.opened&&this.cameraFace===t)return console.log("Camera is already open"),void this.play();console.log("Open camera"),"denied"===await this.getPermission()&&await this.revokePermission(),"front"===t?(this.extends.style.transform="scaleX(-1)",this.extends.style.filter="FlipH"):(this.extends.style.transform="scaleX(1)",this.extends.style.filter=""),await s.open(this.extends,{video:{facingMode:"front"===t?"user":"environment",width:{ideal:n.resolutions[e].width},height:{ideal:n.resolutions[e].height}},audio:!1}),this.cameraFace=t,this.play()}catch(t){throw t}}close(){s.close(this.extends),this.cameraFace=void 0}play(){this.extends.play()}pause(){this.extends.pause()}capture(t){return this.canvas.width=t||this.resolution.width,this.canvas.height=this.resolution.height*(this.canvas.width/this.resolution.width),this.canvas.drawImage(this.extends,0,0,this.resolution.width,this.resolution.height,0,0,this.canvas.width,this.canvas.height).toDataURL("front"===this.cameraFace)}get resolution(){return e.getMediaDimensions(this.extends)}}n.define();class r extends i{constructor(){super(),this.image=document.createElement("img"),this.layer=a.createElement(),this.style.boxSizing="border-box",this.style.display="block",this.style.overflow="hidden","static"===getComputedStyle(this).position&&(this.style.position="relative"),this.appendChild(this.image),this.image.style.boxSizing="border-box",this.image.style.display="block",this.image.style.width="100%",this.image.style.height="100%",this.layer.style.position="absolute",this.appendChild(this.layer),this.observer=new MutationObserver(t=>{for(let e of t)"style"===e.attributeName&&this.redraw()}),this.observer.observe(this,{attributes:!0,attributeFilter:["style"],attributeOldValue:!0}),this.redraw()}static get is(){return"xtejs-image-viewer"}redraw(){const t=getComputedStyle(this);"static"===t.position&&(this.style.position="relative"),this.image.style.objectFit=t.objectFit;const i=e.getMediaDimensions(this.image),a=e.calculateFitDimensions({objectFit:t.objectFit,intrinsicWidth:parseFloat(t.width)-parseFloat(t.paddingRight)-parseFloat(t.borderRightWidth)-parseFloat(t.paddingLeft)-parseFloat(t.borderLeftWidth),intrinsicHeight:parseFloat(t.height)-parseFloat(t.paddingTop)-parseFloat(t.borderTopWidth)-parseFloat(t.paddingBottom)-parseFloat(t.borderBottomWidth),intrinsicTop:parseFloat(t.paddingTop)+parseFloat(t.borderTopWidth)+parseFloat(t.marginTop),intrinsicLeft:parseFloat(t.paddingLeft)+parseFloat(t.borderLeftWidth)+parseFloat(t.marginLeft),actualWidth:i.width,actualHeight:i.height});this.layer.width=i.width,this.layer.height=i.height,this.layer.style.top=`${a.top}px`,this.layer.style.left=`${a.left}px`,this.layer.style.width=`${a.width}px`,this.layer.style.height=`${a.height}px`}get src(){return this.image.getAttribute("src")||""}set src(t){this.image.setAttribute("src",t)}}r.define();!function(t,e){void 0===e&&(e={});var i=e.insertAt;if(t&&"undefined"!=typeof document){var a=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.type="text/css","top"===i&&a.firstChild?a.insertBefore(s,a.firstChild):a.appendChild(s),s.styleSheet?s.styleSheet.cssText=t:s.appendChild(document.createTextNode(t))}}(":root {\n  --camera-capturing-button-scale: 64px;\n  --camera-capturing-button-border: 6px;\n  --camera-capturing-button-touchable-scale: calc( var(--camera-capturing-button-scale) - var(--camera-capturing-button-border) - 10px );\n  --camera-rotation-button-scale: 48px;\n  --camera-captured-scale: 48px;\n}\n\nhtml,\nbody {\n  height: 100%;\n}\n\nbody {\n  margin: 0;\n  overflow: hidden;\n}\n\n.camera-viewer {\n  box-sizing: border-box;\n  display: block;\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  width: 414px;\n  height: 736px;\n  max-width: 100%;\n  max-height: 100%;\n  transform: translate(-50%, -50%);\n  overflow: hidden;\n}\n\n  .camera-viewer-camera {\n    box-sizing: border-box;\n    display: block;\n    position: absolute;\n    z-index: 1001;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n  }\n\n  .camera-viewer-canvas {\n    box-sizing: border-box;\n    display: block;\n    position: absolute;\n    z-index: 1002;\n  }\n\n\n  .camera-controls {\n    box-sizing: border-box;\n    display: block;\n    position: absolute;\n    z-index: 1003;\n    left: 0;\n    bottom: 0;\n    display: flex;\n    justify-content: center;\n    align-items: flex-end;\n    padding: 10px;\n    width: 100%;\n    background: #000000;\n  }\n\n    .camera-captured {\n      box-sizing: border-box;\n      display: block;\n      margin-right: auto;\n      width: var(--camera-captured-scale);\n      height: var(--camera-captured-scale);\n      border: 1px solid hsla(0,0%,100%,.1);\n      border-radius: 4px;\n    }\n\n      .camera-captured img {\n        box-sizing: border-box;\n        display: block;\n        width: 100%;\n        height: 100%;\n        border-radius: 4px;\n      }\n\n    .camera-capturing-button,\n    .camera-rotation-button {\n      padding: 0;\n      border: none;\n      appearance: none;\n      background-color: transparent;\n    }\n\n    .camera-capturing-button:focus,\n    .camera-rotation-button:focus {\n      outline: none;\n      outline-offset: unset;\n    }\n\n    .camera-capturing-button {\n      box-sizing: border-box;\n      position: relative;\n      width: var(--camera-capturing-button-scale);\n      height: var(--camera-capturing-button-scale);\n      border-radius: 50%;\n      border: var(--camera-capturing-button-border) solid #ffffff;\n      background-color: #000000\n    }\n\n      .camera-capturing-button::after {\n        display: block;\n        content: '';\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: var(--camera-capturing-button-touchable-scale);\n        height: var(--camera-capturing-button-touchable-scale);\n        border-radius: 50%;\n        background-color: #ffffff;\n        transition: transform .2s ease;\n      }\n\n      .camera-capturing-button:active::after {\n        transform: translate(-50%, -50%) scale(.85);\n      }\n\n    .camera-rotation-button {\n      margin-left: auto;\n      width: var(--camera-rotation-button-scale);\n      height: var(--camera-rotation-button-scale);\n      background: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9JzMwMHB4JyB3aWR0aD0nMzAwcHgnICBmaWxsPSIjRkZGRkZGIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgNTEyIDUxMiIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PGc+PHBhdGggZD0iTTMwMS44MTUsMzE4LjYwOGMtMTMuMTE0LDExLjAyOS0yOC45NTYsMTcuMzU2LTQ1LjgxNSwxNy4zNTZjLTM2LjM2LDAtNjYuMjg2LTI4Ljk2NS03MC44OS02MS45NjVoMzAuNjFsLTM4Ljg3LTUwICAgbC0zNy41MzQsNTBoMjkuNDc5YzQuNjk2LDQyLDQxLjcxNyw3OCw4Ny4yMDUsNzhjMjAuOSwwLDQxLjE3LTcuNTY2LDU3LjA3Ni0yMS4yMThsMi4zNy0yLjE1OWwtMTEuNTk5LTExLjY2MkwzMDEuODE1LDMxOC42MDh6Ij48L3BhdGg+PHBhdGggZD0iTTMxNS43MzYsMTk4Ljg4NWMtMTYuMTg4LTE0Ljc3NS0zNy40MDItMjIuODM5LTU5LjczNi0yMi44MzljLTIwLjksMC00MS4xNjksNy41NTYtNTcuMDc1LDIxLjIwNmwtMi4zNzEsMi4wNTIgICBsMTEuNTk5LDExLjYxbDIuMDMzLTEuNzA2YzEyLjkyNy0xMC44NzIsMjkuMTk3LTE3LjAwNSw0NS44MTQtMTcuMDA1YzM2LjM0MywwLDY2LjI3NCwyOC43OTcsNzAuODkxLDYzLjc5N2gtMzAuNjQ0bDM4Ljg0Niw1MS4yMjUgICBMMzcyLjcxOSwyNTZoLTI5LjUxMkMzNDAuOTY2LDIzNiwzMzEuMjc1LDIxMy4wNjQsMzE1LjczNiwxOTguODg1eiI+PC9wYXRoPjxwYXRoIGQ9Ik00MTcuNSwxNjBoLTYxLjcyNWMtMzIuMTA1LTM2LTQyLjIxOS00OC01NC41MjUtNDhoLTg4LjVjLTEyLjMxNCwwLTIyLjE2NywxMi01NC41MjEsNDhIMTQ1di0xNmgtMzR2MTZIOTcuNSAgIEM3OS44NTUsMTYwLDY0LDE3My4yMTcsNjQsMTkwLjY4NHYxNzYuMDE4QzY0LDM4NC4xNjksNzkuODU1LDQwMCw5Ny41LDQwMGgzMjBjMTcuNjQ1LDAsMzAuNS0xNS44MzEsMzAuNS0zMy4yOTlWMTkwLjY4NCAgIEM0NDgsMTczLjIxNyw0MzUuMTQ1LDE2MCw0MTcuNSwxNjB6IE00MzIsMzY2LjcwMWMwLDkuMjYzLTYuMjI5LDE3LjI5OS0xNC41LDE3LjI5OWgtMzIwYy04LjczOCwwLTE3LjUtOC42NjQtMTcuNS0xNy4yOTlWMTkwLjY4NCAgIEM4MCwxODIuNTE4LDg4LjEyNiwxNzYsOTcuNSwxNzZoNjAuNzI5YzAsMCw0LjEyNCwwLDYuMTMzLDBzMy4yMjUtMC4xOTksNS43NjgtMy4yczcuNzAyLTEwLjAwOCwxMS4wOC0xMy43OTUgICBjMTEuMjk2LTEyLjY2NiwxOS40NTctMjEuOTE1LDI1LjMxNi0yNy4xMzJjNC43NDYtNC4yMjUsNi4yMTEtMy44NzMsNi4yMjUtMy44NzNoODguNWMwLjAxNiwwLDEuNjExLTAuMzYzLDYuNzA5LDQuMjE5ICAgYzYuMTQxLDUuNTIxLDE0LjcwNSwxNi44NCwyNi41NTgsMzAuMTk4YzIuODg4LDMuMjU1LDcuMjE0LDguMTEsOS4zMTcsMTAuNDRzNC4yNTIsMy4xNDMsNS43NzEsMy4xNDNzNi4xNywwLDYuMTcsMEg0MTcuNSAgIGM4LjgzMiwwLDE0LjUsNS45NjUsMTQuNSwxNC42ODRWMzY2LjcwMXoiPjwvcGF0aD48L2c+PC9zdmc+) center / contain no-repeat transparent;\n      transition: opacity .2s ease;\n    }\n\n      .camera-rotation-button:active {\n        opacity: .5;\n      }\n");class o extends i{constructor(){super(),this.camera=n.createElement(),this.canvas=a.createElement(),this.classList.add("camera-viewer"),"static"===getComputedStyle(this).position&&(this.style.position="relative"),this.camera.classList.add("camera-viewer-camera"),this.appendChild(this.camera),this.canvas.classList.add("camera-viewer-canvas"),this.appendChild(this.canvas),this.observer=new MutationObserver(t=>{for(let e of t)"style"===e.attributeName&&this.redraw()}),this.observer.observe(this,{attributes:!0,attributeFilter:["style"],attributeOldValue:!0}),this.redraw()}connectedCallback(){if(super.connectedCallback(),null!=this.getAttribute("controls")){this.insertAdjacentHTML("beforeend",'<div class="camera-controls">\n          <a class="camera-captured"><img element-captured></a>\n          <button action-capturing class="camera-capturing-button" type="button"></button>\n          <button action-rotation class="camera-rotation-button" type="button"></button>\n        </div>');const t=window.ontouchstart?"touchstart":"click",e=this.querySelector("[element-captured]");this.querySelector("[action-capturing]").addEventListener(t,()=>{e.setAttribute("src",this.camera.capture())}),this.querySelector("[action-rotation]").addEventListener(t,async()=>{await this.camera.open("front"===this.camera.cameraFace?"back":"front")})}null!=this.getAttribute("autoplay")&&this.camera.open("back"===this.getAttribute("autoplay")?"back":"front")}static get is(){return"xtejs-camera-viewer"}redraw(){const t=getComputedStyle(this);"static"===t.position&&(this.style.position="relative");const i=this.camera.resolution,a=e.calculateFitDimensions({objectFit:this.camera.extends.style.objectFit,intrinsicWidth:parseFloat(t.width)-parseFloat(t.paddingRight)-parseFloat(t.borderRightWidth)-parseFloat(t.paddingLeft)-parseFloat(t.borderLeftWidth),intrinsicHeight:parseFloat(t.height)-parseFloat(t.paddingTop)-parseFloat(t.borderTopWidth)-parseFloat(t.paddingBottom)-parseFloat(t.borderBottomWidth),intrinsicTop:parseFloat(t.paddingTop)+parseFloat(t.borderTopWidth)+parseFloat(t.marginTop),intrinsicLeft:parseFloat(t.paddingLeft)+parseFloat(t.borderLeftWidth)+parseFloat(t.marginLeft),actualWidth:i.width,actualHeight:i.height});this.canvas.width=i.width,this.canvas.height=i.height,this.canvas.style.top=`${a.top}px`,this.canvas.style.left=`${a.left}px`,this.canvas.style.width=`${a.width}px`,this.canvas.style.height=`${a.height}px`}}o.define(),exports.Camera=n,exports.CameraViewer=o,exports.Canvas=a,exports.ImageViewer=r,exports.version="0.0.0";
